<!-- En-t√™te -->
<div class="tackheader">
  <div class="tackheader-1">
    <p>Liste des t√¢ches</p>
  </div>

  <div class="tackheader-left">
    <div class="listuser" *ngFor="let item of visibleUsers" (click)="selectUser(item)" >
      <div type="button"  [ngClass]="userid.id==item.id ?'glow-border':''">
        <ng-container *ngIf="item.profile_image_url; else defaultProfile">
          <img [src]="item.profile_image_url" alt="Image de profil" class="enteimg" />
        </ng-container>
        <ng-template #defaultProfile>
          <i class="bi bi-person-circle"></i>
        </ng-template>
        <sup class="addtt">
          <i class="bi bi-plus" data-bs-toggle="tooltip" title="Ajouter t√¢che"></i>
        </sup>
      </div>
    </div>

    <!-- Afficher les utilisateurs restants -->
    <div *ngIf="!showAllUsers && hiddenUserCount > 0" class="more-users">
      <button class="btn btn-link" (click)="toggleShowAllUsers()">
        +{{ hiddenUserCount }}
      </button>
    </div>
  </div>
</div>

<!-- Colonnes de t√¢ches -->
<div class="tache-container">
  <div class="tache-column" *ngFor="let statut of statutKeys">
    <h3>{{ statut | uppercase }}</h3>
  
    <div
      cdkDropList
      [id]="statut"
      [cdkDropListData]="tachesByStatus[statut]"
      (cdkDropListDropped)="drop($event, statut)"
      [cdkDropListConnectedTo]="statutKeys"
      class="tache-list"
    >
      <div
        class="tache-card"
        *ngFor="let tache of tachesByStatus[statut]"
        cdkDrag
        [cdkDragData]="tache"
        
      >
        <div *ngIf="tache" class="d-flex justify-content-between " >
          <div >
          <strong  class="cursor-pointer">{{ tache.titre }}  </strong>
          </div>
          <div class=" d-flex gap-3">
            <button  class="btn btn-danger p-1"(click)="onDeleteTache(tache.id)">   
              <i class="bi bi-trash"  data-bs-toggle="tooltip" title="Supprimer t√¢che"></i>
            </button>
            <button  class="btn  btn-warning p-1"(click)="selectTache(tache)" > 
              <i class="bi bi-pencil-square" data-bs-toggle="tooltip" title="Edit t√¢che" ></i>
            </button>
                   <button  class="btn  btn-warning p-1"(click)="openPopupshow(tache)" > 
                  <i class="bi bi-display"  data-bs-toggle="tooltip" title="Affiche t√¢che" ></i>
                   </button>
         
            </div>
        </div>
        <div class="resume">
        <!-- üëá Affichage utilisateur assign√© -->
        <small class="text-muted mt-1">
          Assign√©e √† : {{ getUserById(tache.user_id)?.name || 'Utilisateur inconnu' }}
        </small> 
        <small class="text-muted mt-1">
          Date fin : {{ tache?.end_date | date:'d MMMM y' : '' : 'fr' }}

        </small>
        </div>
        <!-- <p>{{ tache.description }}</p> -->
        <!-- <div class="description-content" [innerHTML]="tache.description"></div> -->

        <div *ngIf="!tache || !tache.titre">Aucune t√¢che</div>
      </div>
    </div>
  </div>
  
</div>

<!-- Modal utilisateur -->
<div class="modal" tabindex="-1" role="dialog" [ngStyle]="{'display': displayStyle}">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">D√©tails de {{ selectedUser?.name || 'Utilisateur inconnu' }}</h4>
        <button type="button" class="btn-close" (click)="closePopup()"></button>
      </div>
      <div class="modal-body">
        <div class="user-info">
          <p><strong>Nom : </strong>{{ selectedUser?.name || '-' }}</p>
          <p><strong>Email : </strong>{{ selectedUser?.email || '-' }}</p>
          <p><strong>R√¥le : </strong>{{ selectedUser?.role || '-' }}</p>
          <p><strong>T√¢ches assign√©es : </strong>{{ selectedUser?.tasksCount || 0 }}</p>
        </div>

        <!-- Formulaire ajout t√¢che -->
        <form (ngSubmit)="addTask()" *ngIf="selectedUser">
            <!-- S√©lection de la p√©riode de tache -->
          <input
            type="text"
            class="form-control mb-3"
            ngxDaterangepickerMd
            [(ngModel)]="selected"
            [ngModelOptions]="{ standalone: true }"
            [autoApply]="true"
            placeholder="S√©lectionner une p√©riode"
          />

          <div class="form-group">
            <label for="taskTitle">Titre</label>
            <input type="text" id="taskTitle" class="form-control" [(ngModel)]="newTask.titre" name="titre" required />
          </div>
          <div class="form-group">
            <label for="taskDescription">Description</label>
            <!-- <textarea id="taskDescription" class="form-control" [(ngModel)]="newTask.description" name="description"></textarea> -->
            <quill-editor [(ngModel)]="newTask.description" [ngModelOptions]="{standalone: true}"></quill-editor>

          </div>
          <!-- <div class="form-group">
            <label for="taskStatut">Statut</label>
            <select id="taskStatut" class="form-control" [(ngModel)]="newTask.statut" name="statut">
              <option value="todo">√Ä faire</option>
              <option value="in_progress">En cours</option>
              <option value="done">Termin√©</option>
            </select>
          </div> -->
          <div class="form-group d-flex justify-content-end gap-3 mt-3">
            <button type="submit" class="btn btn-success">Ajouter</button>
            <button type="button" class="btn btn-danger" (click)="reset()">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<!-- Modal t√¢che (pour afficher et modifier les informations de la t√¢che) -->
<div class="modal" tabindex="-1" role="dialog" [ngStyle]="{'display': displayStyleTache}">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Modifier la t√¢che</h4>
        <button type="button" class="btn-close" (click)="closePopupTache()"></button>
      </div>
      <div class="modal-body">
        <!-- Affichage des informations de la t√¢che -->
        <p><strong>Titre :</strong> {{ selectedTache?.titre }}</p>
             
        <!-- <p><strong>Description :</strong> </p>
        <div class="description-content" id="imageeditor" [innerHTML]="selectedTache?.description"></div> -->
        <p><strong>Statut :</strong> {{ selectedTache?.statut }}</p>
        <p><strong>Assign√©e √† :</strong> {{ selectedusermodal?.email || 'Aucun utilisateur' }}</p>
        <!-- Formulaire de modification -->
        <form *ngIf="selectedTache" (ngSubmit)="updateTacheInfo()">      
          <div class="form-group">
                <div class="form-group">
            <label for="taskTitle">Titre</label>
            <input type="text" id="taskTitle" class="form-control" [(ngModel)]="selectedTache.titre" name="titre" required />
          </div>
            <label for="taskDescription">Description</label>
            <quill-editor id="imageeditor" [(ngModel)]="selectedTache.description" [ngModelOptions]="{standalone: true}"></quill-editor>
          </div>        
          <div class="form-group d-flex justify-content-end gap-3 mt-3">
            <button type="submit" class="btn btn-success">Mettre √† jour</button>
            <button type="button" class="btn btn-danger" (click)="closePopupTache()">Annuler</button>
          </div>
        </form>
        
      </div>
    </div>
  </div>
</div>




<!-- Modal t√¢che (affichage + ajout de commentaire) -->
<div class="modal" tabindex="-1" role="dialog" [ngStyle]="{ 'display': ShowStyleTache }">
  <div class="modal-dialog" role="document">
    <div class="modal-content" *ngIf="selectedshowTache as tache">
      <div class="modal-header">
        <h4 class="modal-title">Afficher la t√¢che</h4>
        <button type="button" class="btn-close" (click)="closePopupshowTache()"></button>
      </div>
      <div class="modal-body">
        <!-- Infos t√¢che -->
        <p><strong>Titre :</strong> {{ tache.titre }}</p>
        <p><strong>Statut :</strong> {{ tache.statut }}</p>
       <p><strong>Assign√©e √† :</strong> {{ selectedusermodal?.email || 'Aucun utilisateur' }}</p>


        <!-- Description -->
        <div class="form-group">
          <label>Description</label>
          <quill-editor
            [readOnly]="true"
            [ngModel]="tache.description"
            [ngModelOptions]="{ standalone: true }"
          ></quill-editor>
        </div>

        <!-- Commentaires existants -->
        <div *ngIf="tache.comments?.length" class="mt-3">
          <strong>Commentaires :</strong>
          <ul class="list-unstyled">
            <li *ngFor="let comment of tache.comments" class="mb-2">
              <div class="border rounded p-2 bg-light">
                <span>{{ comment.content }}</span><br />
                <small class="text-muted">{{ comment.created_at | date:'short' }}</small>
              </div>
            </li>
          </ul>
        </div>

        <!-- Ajout commentaire -->
        <div class="mt-3">
          <label>Ajouter un commentaire :</label>
          <textarea
            class="form-control"
            rows="2"
            [(ngModel)]="newComment[tache.id!]"
            placeholder="Saisir un commentaire..."
          ></textarea>
        </div>

        <!-- Boutons -->
        <div class="d-flex justify-content-end gap-3 mt-3">
          <button type="button" class="btn btn-success" (click)="ajouterCommentaire(tache.id!)">Ajouter</button>
          <button type="button" class="btn btn-danger" (click)="closePopupshowTache()">Fermer</button>
        </div>
      </div>
    </div>
  </div>
</div>




<!-- Modal des utilisateurs cach√©s -->
<div class="modal" tabindex="-1" role="dialog" [ngStyle]="{'display': showHiddenUsersModal ? 'block' : 'none'}">
  <div class="modal-dialog modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Utilisateurs restants</h5>
        <button type="button" class="btn-close" (click)="closeHiddenUsersModal()"></button>
      </div>
      <div class="modal-body">
            <span class="d-block mb-4"> Membres de  l'espace du travail</span>
          <div class="form-group mb-4">
            <input type="text"  class="form-control" placeholder="Recherche membre"  [(ngModel)]="searchTerm" name="search"  />
          </div>  <div class="list-group membres">
    <div class="listuser " *ngFor="let item of filteredUsers()" (click)="selectUser(item)">
      <div type="button"  data-bs-toggle="tooltip" [attr.title]="item.name" >
        <ng-container *ngIf="item.profile_image_url; else defaultProfile">
          <img [src]="item.profile_image_url" alt="Image de profil" class="enteimg" />
        </ng-container>
        <ng-template #defaultProfile>
          <i class="bi bi-person-circle"></i>
        </ng-template>
        <sup class="addtt">
          <i class="bi bi-plus" data-bs-toggle="tooltip" title="Ajouter t√¢che"></i>
        </sup>
      </div>
    </div>
        </div>
      </div>
    </div>
  </div>
</div>

